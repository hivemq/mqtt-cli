name: CI Check

on: [pull_request]

env:
  integration-test-split-total: 5
  system-test-split-total: 11
  native-system-test-split-total: 12

concurrency:
  group: check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-split-index-json:
    name: Generate split indexes
    runs-on: ubuntu-latest
    steps:
      - name: Generate integration test split index list
        id: integration
        uses: donnerbart/split-tests-java-action/generate-split-index-json@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          split-total: ${{ env.integration-test-split-total }}
      - name: Generate system test split index list
        id: system
        uses: donnerbart/split-tests-java-action/generate-split-index-json@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          split-total: ${{ env.system-test-split-total }}
      - name: Generate native system test split index list
        id: native-system
        uses: donnerbart/split-tests-java-action/generate-split-index-json@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          split-total: ${{ env.native-system-test-split-total }}
    outputs:
      integration-json: ${{ steps.integration.outputs.split-index-json }}
      system-json: ${{ steps.system.outputs.split-index-json }}
      native-system-json: ${{ steps.native-system.outputs.split-index-json }}

  compile:
    name: Compile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Setup Java
        id: setup-java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: |
            11
            21
          cache: gradle
      - name: Setup GraalVM
        run: ./gradlew installNativeImageTooling
      - name: Warmup Gradle cache
        if: ${{ steps.setup-java.outputs.cache-hit == 'false' }}
        run: ./gradlew compileIntegrationTestJava compileSystemTestJava shadowJar nativeCompile

  unit-test:
    name: Unit tests
    runs-on: ubuntu-latest
    needs:
      - compile
    timeout-minutes: 15
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: |
            11
            21
          cache: gradle
      - name: Run unit tests
        run: ./gradlew test --stacktrace
      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: Unit test results
          path: |
            build/reports/tests/test/
            build/test-results/test/
          retention-days: 5
      - name: Publish test report
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: Unit tests report
          path: '**/build/test-results/test/TEST-*.xml'
          reporter: java-junit
          fail-on-error: false

  integration-test:
    name: "Integration test #${{ matrix.split-index }}"
    runs-on: ubuntu-latest
    needs:
      - generate-split-index-json
      - compile
    timeout-minutes: 25
    permissions:
      contents: read
      checks: write
    strategy:
      fail-fast: false
      matrix:
        split-index: ${{ fromjson(needs.generate-split-index-json.outputs.integration-json) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Checkout JUnit reports
        uses: donnerbart/split-tests-java-action/checkout-junit-reports@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          split-index: ${{ matrix.split-index }}
          git-branch: junit-reports/integration/${{ github.base_ref }}
          path: junit-reports
          artifact-name: junit-reports-sha-integration
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: |
            11
            21
          cache: gradle
      - name: Compile integration tests
        run: ./gradlew compileIntegrationTestJava
      - name: Split tests
        id: split-tests
        uses: donnerbart/split-tests-java-action@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          glob: '**/src/integrationTest/java/**/*IT.java'
          split-index: ${{ matrix.split-index }}
          split-total: ${{ env.integration-test-split-total }}
          junit-glob: '**/junit-reports/*.xml'
          format: gradle
          new-test-time: average
          calculate-optimal-total-split: true
          debug: true
      - name: Run integration tests
        env:
          ORG_GRADLE_PROJECT_dockerHubUsername: ${{ secrets.DOCKER_USERNAME }}
          ORG_GRADLE_PROJECT_dockerHubPassword: ${{ secrets.DOCKER_TOKEN }}
        run: ./gradlew integrationTest ${{ steps.split-tests.outputs.test-suite }} --stacktrace
      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: "Integration test results #${{ matrix.split-index }}"
          path: |
            build/reports/tests/integrationTest/
            build/test-results/integrationTest/
          retention-days: 5
      - name: Upload JUnit report artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: junit-xml-reports-integration-${{ matrix.split-index }}
          path: build/test-results/integrationTest/*.xml
      - name: Publish test report
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: Integration tests report
          path: '**/build/test-results/integrationTest/TEST-*.xml'
          reporter: java-junit
          fail-on-error: false
      - name: Install xmllint
        if: failure()
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils
      - name: Set annotations for failed tests
        if: failure()
        run: |
          find build/test-results/integrationTest -type f -name "*.xml" | while read -r FILE; do
            COUNT=$(xmllint --xpath 'count(//testcase[failure or error])' "$FILE")
            for INDEX in $(seq 1 "$COUNT"); do
              TEST_CLASS=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/@classname)" "$FILE" 2>/dev/null)
              TEST_METHOD=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/@name)" "$FILE" 2>/dev/null)
              MESSAGE=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/failure/@message | (//testcase[failure or error])[$INDEX]/error/@message)" "$FILE" 2>/dev/null)
              [ -z "$MESSAGE" ] && MESSAGE="Test failed"
              echo "::error title=Integration test #${{ matrix.split-index }}::$TEST_CLASS.$TEST_METHOD%0A$MESSAGE"
            done
          done

  system-test:
    name: "System test #${{ matrix.split-index }}"
    runs-on: ubuntu-latest
    needs:
      - generate-split-index-json
      - compile
    timeout-minutes: 25
    permissions:
      contents: read
      checks: write
    strategy:
      fail-fast: false
      matrix:
        split-index: ${{ fromjson(needs.generate-split-index-json.outputs.system-json) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Checkout JUnit reports
        uses: donnerbart/split-tests-java-action/checkout-junit-reports@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          split-index: ${{ matrix.split-index }}
          git-branch: junit-reports/system/${{ github.base_ref }}
          path: junit-reports
          artifact-name: junit-reports-sha-system
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: |
            11
            21
          cache: gradle
      - name: Compile system tests
        run: ./gradlew compileSystemTestJava shadowJar
      - name: Split tests
        id: split-tests
        uses: donnerbart/split-tests-java-action@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          glob: '**/src/systemTest/java/**/*ST.java'
          split-index: ${{ matrix.split-index }}
          split-total: ${{ env.system-test-split-total }}
          junit-glob: '**/junit-reports/*.xml'
          format: gradle
          new-test-time: average
          calculate-optimal-total-split: true
          debug: true
      - name: Run system tests
        env:
          ORG_GRADLE_PROJECT_dockerHubUsername: ${{ secrets.DOCKER_USERNAME }}
          ORG_GRADLE_PROJECT_dockerHubPassword: ${{ secrets.DOCKER_TOKEN }}
        run: ./gradlew systemTest ${{ steps.split-tests.outputs.test-suite }} --stacktrace
      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: "System test results #${{ matrix.split-index }}"
          path: |
            build/reports/tests/systemTest/
            build/test-results/systemTest/
          retention-days: 5
      - name: Upload JUnit report artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: junit-xml-reports-system-${{ matrix.split-index }}
          path: build/test-results/systemTest/*.xml
      - name: Publish test report
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: System tests report
          path: '**/build/test-results/systemTest/TEST-*.xml'
          reporter: java-junit
          fail-on-error: false
      - name: Install xmllint
        if: failure()
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils
      - name: Set annotations for failed tests
        if: failure()
        run: |
          find build/test-results/systemTest -type f -name "*.xml" | while read -r FILE; do
            COUNT=$(xmllint --xpath 'count(//testcase[failure or error])' "$FILE")
            for INDEX in $(seq 1 "$COUNT"); do
              TEST_CLASS=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/@classname)" "$FILE" 2>/dev/null)
              TEST_METHOD=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/@name)" "$FILE" 2>/dev/null)
              MESSAGE=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/failure/@message | (//testcase[failure or error])[$INDEX]/error/@message)" "$FILE" 2>/dev/null)
              [ -z "$MESSAGE" ] && MESSAGE="Test failed"
              echo "::error title=System test #${{ matrix.split-index }}::$TEST_CLASS.$TEST_METHOD%0A$MESSAGE"
            done
          done

  native-system-test:
    name: "Native system test #${{ matrix.split-index }}"
    runs-on: ubuntu-latest
    needs:
      - generate-split-index-json
      - compile
    timeout-minutes: 25
    permissions:
      contents: read
      checks: write
    strategy:
      fail-fast: false
      matrix:
        split-index: ${{ fromjson(needs.generate-split-index-json.outputs.native-system-json) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Checkout JUnit reports
        uses: donnerbart/split-tests-java-action/checkout-junit-reports@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          split-index: ${{ matrix.split-index }}
          git-branch: junit-reports/native-system/${{ github.base_ref }}
          path: junit-reports
          artifact-name: junit-reports-sha-native-system
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: |
            11
            21
          cache: gradle
      - name: Setup GraalVM
        run: ./gradlew installNativeImageTooling
      - name: Compile native system tests
        run: ./gradlew compileSystemTestJava nativeCompile
      - name: Split tests
        id: split-tests
        uses: donnerbart/split-tests-java-action@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          glob: '**/src/systemTest/java/**/*ST.java'
          split-index: ${{ matrix.split-index }}
          split-total: ${{ env.native-system-test-split-total }}
          junit-glob: '**/junit-reports/*.xml'
          format: gradle
          new-test-time: average
          calculate-optimal-total-split: true
          debug: true
      - name: Run native system tests
        env:
          ORG_GRADLE_PROJECT_dockerHubUsername: ${{ secrets.DOCKER_USERNAME }}
          ORG_GRADLE_PROJECT_dockerHubPassword: ${{ secrets.DOCKER_TOKEN }}
        run: ./gradlew systemTestNative ${{ steps.split-tests.outputs.test-suite }} --stacktrace
      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: "Native system test results #${{ matrix.split-index }}"
          path: |
            build/reports/tests/systemTestNative/
            build/test-results/systemTestNative/
          retention-days: 5
      - name: Upload JUnit report artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: junit-xml-reports-native-system-${{ matrix.split-index }}
          path: build/test-results/systemTestNative/*.xml
      - name: Publish test report
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: Native system tests report
          path: '**/build/test-results/systemTestNative/TEST-*.xml'
          reporter: java-junit
          fail-on-error: false
      - name: Install xmllint
        if: failure()
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils
      - name: Set annotations for failed tests
        if: failure()
        run: |
          find build/test-results/systemTestNative -type f -name "*.xml" | while read -r FILE; do
            COUNT=$(xmllint --xpath 'count(//testcase[failure or error])' "$FILE")
            for INDEX in $(seq 1 "$COUNT"); do
              TEST_CLASS=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/@classname)" "$FILE" 2>/dev/null)
              TEST_METHOD=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/@name)" "$FILE" 2>/dev/null)
              MESSAGE=$(xmllint --xpath "string((//testcase[failure or error])[$INDEX]/failure/@message | (//testcase[failure or error])[$INDEX]/error/@message)" "$FILE" 2>/dev/null)
              [ -z "$MESSAGE" ] && MESSAGE="Test failed"
              echo "::error title=Native system test #${{ matrix.split-index }}::$TEST_CLASS.$TEST_METHOD%0A$MESSAGE"
            done
          done

  build-packages:
    name: Build packages
    runs-on: ubuntu-latest
    needs:
      - compile
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: |
            11
            21
          cache: gradle
      - name: Build packages
        run: ./gradlew buildPackages
      - name: Upload Debian package
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: debian-package
          path: build/packages/debian/
          retention-days: 5
      - name: Upload RPM package
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: rpm-package
          path: build/packages/rpm/
          retention-days: 5
      - name: Upload Brew package
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: brew-package
          path: build/packages/homebrew/
          retention-days: 5
      - name: Upload Windows package
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: windows-package
          path: build/packages/windows/
          retention-days: 5

  windows-smoke-test:
    name: Windows smoke test
    runs-on: windows-latest
    needs:
      - build-packages
    timeout-minutes: 10
    steps:
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: 11
      - name: Download Windows package
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8
        with:
          name: windows-package
          path: windows-package
      - name: Extract Windows ZIP
        run: |
          $zip = Get-ChildItem -Path windows-package -Filter "mqtt-cli-*-win.zip" | Select-Object -First 1
          Expand-Archive -Path $zip.FullName -DestinationPath mqtt-cli
        shell: pwsh
      - name: Run mqtt-cli --version
        run: |
          $output = & mqtt-cli/mqtt-cli.exe --version 2>&1
          echo $output
          if ($LASTEXITCODE -ne 0) { exit 1 }
        shell: pwsh
      - name: Run mqtt-cli --help
        run: |
          $output = & mqtt-cli/mqtt-cli.exe --help 2>&1
          echo $output
          if ($LASTEXITCODE -ne 0) { exit 1 }
        shell: pwsh

  debian-smoke-test:
    name: Debian smoke test
    runs-on: ubuntu-latest
    needs:
      - build-packages
    timeout-minutes: 10
    steps:
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: 11
      - name: Download Debian package
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8
        with:
          name: debian-package
          path: debian-package
      - name: Install Debian package
        run: sudo dpkg --force-depends -i debian-package/mqtt-cli-*.deb
      - name: Run mqtt --version
        run: mqtt --version
      - name: Run mqtt --help
        run: mqtt --help

  rpm-smoke-test:
    name: RPM smoke test
    runs-on: ubuntu-latest
    needs:
      - build-packages
    timeout-minutes: 10
    steps:
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: 11
      - name: Install rpm tooling
        run: sudo apt-get update && sudo apt-get install -y rpm
      - name: Download RPM package
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8
        with:
          name: rpm-package
          path: rpm-package
      - name: Install RPM package
        run: sudo rpm -ivh --nodeps rpm-package/mqtt-cli-*.rpm
      - name: Run mqtt --version
        run: mqtt --version
      - name: Run mqtt --help
        run: mqtt --help

  brew-smoke-test:
    name: Brew smoke test
    runs-on: ubuntu-latest
    needs:
      - build-packages
    timeout-minutes: 10
    steps:
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: temurin
          java-version: 11
      - name: Download Brew package
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8
        with:
          name: brew-package
          path: brew-package
      - name: Extract and fix up Brew package
        run: |
          unzip brew-package/mqtt-cli-*-brew.zip -d brew
          JAR_PATH=$(pwd)/$(ls brew/brew/mqtt-cli-*.jar)
          sed -i "s|##PREFIX##|$JAR_PATH|" brew/brew/mqtt
          chmod +x brew/brew/mqtt
      - name: Run mqtt --version
        run: brew/brew/mqtt --version
      - name: Run mqtt --help
        run: brew/brew/mqtt --help

  merge-junit-reports-integration:
    name: Merge JUnit reports (integration)
    runs-on: ubuntu-latest
    needs:
      - integration-test
    permissions:
      contents: write
    steps:
      - name: Merge JUnit reports
        uses: donnerbart/split-tests-java-action/merge-junit-reports@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          git-branch: junit-reports/integration/${{ github.base_ref }}
          artifact-name: junit-xml-reports-integration-${{ github.base_ref }}
          split-artifact-pattern: junit-xml-reports-integration-*

  merge-junit-reports-system:
    name: Merge JUnit reports (system)
    runs-on: ubuntu-latest
    needs:
      - system-test
    permissions:
      contents: write
    steps:
      - name: Merge JUnit reports
        uses: donnerbart/split-tests-java-action/merge-junit-reports@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          git-branch: junit-reports/system/${{ github.base_ref }}
          artifact-name: junit-xml-reports-system-${{ github.base_ref }}
          split-artifact-pattern: junit-xml-reports-system-*

  merge-junit-reports-native-system:
    name: Merge JUnit reports (native system)
    runs-on: ubuntu-latest
    needs:
      - native-system-test
    permissions:
      contents: write
    steps:
      - name: Merge JUnit reports
        uses: donnerbart/split-tests-java-action/merge-junit-reports@4153fa0b436141302155e03df99e8e6d5139fb23 # v1
        with:
          git-branch: junit-reports/native-system/${{ github.base_ref }}
          artifact-name: junit-xml-reports-native-system-${{ github.base_ref }}
          split-artifact-pattern: junit-xml-reports-native-system-*

  check:
    name: check
    if: always()
    runs-on: ubuntu-latest
    needs:
      - generate-split-index-json
      - compile
      - unit-test
      - integration-test
      - system-test
      - native-system-test
      - build-packages
      - windows-smoke-test
      - debian-smoke-test
      - rpm-smoke-test
      - brew-smoke-test
      - merge-junit-reports-integration
      - merge-junit-reports-system
      - merge-junit-reports-native-system
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.generate-split-index-json.result }}" != "success" ]]; then
            echo "generate-split-index-json job failed"
            exit 1
          fi
          if [[ "${{ needs.compile.result }}" != "success" ]]; then
            echo "compile job failed"
            exit 1
          fi
          if [[ "${{ needs.unit-test.result }}" != "success" ]]; then
            echo "unit-test job failed"
            exit 1
          fi
          if [[ "${{ needs.integration-test.result }}" != "success" ]]; then
            echo "integration-test job failed"
            exit 1
          fi
          if [[ "${{ needs.system-test.result }}" != "success" ]]; then
            echo "system-test job failed"
            exit 1
          fi
          if [[ "${{ needs.merge-junit-reports-integration.result }}" != "success" ]]; then
            echo "merge-junit-reports-integration job failed"
            exit 1
          fi
          if [[ "${{ needs.merge-junit-reports-system.result }}" != "success" ]]; then
            echo "merge-junit-reports-system job failed"
            exit 1
          fi
          if [[ "${{ needs.native-system-test.result }}" != "success" ]]; then
            echo "native-system-test job failed"
            exit 1
          fi
          if [[ "${{ needs.build-packages.result }}" != "success" ]]; then
            echo "build-packages job failed"
            exit 1
          fi
          if [[ "${{ needs.windows-smoke-test.result }}" != "success" ]]; then
            echo "windows-smoke-test job failed"
            exit 1
          fi
          if [[ "${{ needs.debian-smoke-test.result }}" != "success" ]]; then
            echo "debian-smoke-test job failed"
            exit 1
          fi
          if [[ "${{ needs.rpm-smoke-test.result }}" != "success" ]]; then
            echo "rpm-smoke-test job failed"
            exit 1
          fi
          if [[ "${{ needs.brew-smoke-test.result }}" != "success" ]]; then
            echo "brew-smoke-test job failed"
            exit 1
          fi
          if [[ "${{ needs.merge-junit-reports-native-system.result }}" != "success" ]]; then
            echo "merge-junit-reports-native-system job failed"
            exit 1
          fi
          echo "All jobs completed successfully"
